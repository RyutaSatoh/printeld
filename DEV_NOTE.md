# Print-ETL-D 開発メモ (2026-01-17)

## 1. 達成事項
*   **コア機能の実装**: ファイル監視、LLM抽出、アクション実行のパイプラインを確立。
*   **カレンダー連携 (CalDAV)**:
    *   `caldav` ライブラリを用いた同期機能を実装。
    *   `dispatcher.py` から同期ロジックを `caldav_sync.py` に分離・リファクタリング。
    *   Baikalサーバーとの互換性（iCalendar形式の厳密化）を確保。
    *   カテゴリ名（りっちゃん等）からカレンダー名への動的マッピングを実装。
*   **ユニバーサル対応**:
    *   単一の `unified_entry_point` プロファイルであらゆる書類に対応。
    *   月間予定表（Monthly）と週間予定表（Weekly）の抽出に対応。
    *   ネストされたスキーマ（日付ごとのリスト）の実装。
*   **運用性向上**:
    *   `.gitignore` と `config.yaml.sample` の整備。
    *   `scanner_llm_classifier` のロジック（カテゴリ定義の動的読み込み）を完全移植し、依存を削除。

## 2. カレンダー同期の課題（重複登録）
月間予定表と週間予定表で同じ日の予定が処理されると、現状では二重登録されるケースがある。

### 現象
*   月間予定: 「1/16 短縮4校時（13時下校）」
*   週間予定: 「1/16 給食あり13時下校」
*   **結果**: 日付は同じだがタイトル（Summary）が一致しないため、重複チェックをすり抜けて両方登録される。

### 今後の対策案
次回の開発フェーズで以下のアプローチを検討する。

1.  **決定論的UIDの採用 (推奨)**
    *   `uuid4()`（ランダム）ではなく、`Hash(Date + "SchoolEvent")` のように一意なIDを生成する。
    *   これにより、同じ日の学校行事は常に同じUIDとなり、CalDAVサーバー側で自動的に上書き（マージ）される。
2.  **類似度判定の導入**
    *   `difflib` 等でタイトルの類似度を計算し、閾値を超えたら更新とみなす。
3.  **優先度ロジック**
    *   「週間予定は月間予定を常に上書きする」というルールを実装する。

## 3. 次のアクション
*   重複回避ロジックの実装（`caldav_sync.py` の改修）。
*   Webダッシュボード等のUI検討。
